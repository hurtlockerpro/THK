name: Secrets Demo - Deploy to Staging

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

# Define environments
env:
  APP_NAME: demo-github-actions
  NODE_VERSION: '18'

jobs:
  # Job 1: Using Repository Secrets
  build-with-secrets:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Display public environment variables
      run: |
        echo "App Name: ${{ env.APP_NAME }}"
        echo "Node Version: ${{ env.NODE_VERSION }}"
        echo "GitHub Repository: ${{ github.repository }}"
        echo "GitHub Actor: ${{ github.actor }}"
        
    - name: Use Repository Secret (API Key example)
      run: |
        echo "Using API Key from repository secrets..."
        # The actual secret value is hidden in logs
        echo "API Key length: ${#API_KEY}"
        echo "First 4 characters: ${API_KEY:0:4}****"
      env:
        API_KEY: ${{ secrets.API_KEY }}
        
    - name: Use Repository Secret (Database URL example)
      run: |
        echo "Database connection configured"
        # Never echo the actual secret!
        if [ -n "$DATABASE_URL" ]; then
          echo "✓ Database URL is set"
        else
          echo "✗ Database URL is not set"
        fi
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Install dependencies
      run: npm install
      
    - name: Build with environment variables
      run: npm run build
      env:
        NEXT_PUBLIC_API_URL: ${{ secrets.API_URL }}

  # Job 2: Using Environment-specific Secrets
  deploy-to-staging:
    runs-on: ubuntu-latest
    environment: staging
    needs: build-with-secrets
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Display environment info
      run: |
        echo "Deploying to: staging"
        echo "Environment URL: ${{ vars.ENVIRONMENT_URL }}"
        
    - name: Use Staging Environment Secrets
      run: |
        echo "Using staging-specific secrets..."
        if [ -n "$STAGING_API_KEY" ]; then
          echo "✓ Staging API Key is configured"
        fi
        if [ -n "$STAGING_SERVER" ]; then
          echo "✓ Staging Server: $STAGING_SERVER"
        fi
      env:
        STAGING_API_KEY: ${{ secrets.STAGING_API_KEY }}
        STAGING_SERVER: ${{ vars.STAGING_SERVER }}
        
    - name: Simulate deployment
      run: |
        echo "Deploying application..."
        echo "Deployment timestamp: $(date)"
        echo "✓ Deployment successful!"

  # Job 3: Using Multiple Environments
  deploy-to-production:
    runs-on: ubuntu-latest
    environment: production
    needs: deploy-to-staging
    # This will require manual approval if configured
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Display environment info
      run: |
        echo "Deploying to: production"
        echo "Environment URL: ${{ vars.ENVIRONMENT_URL }}"
        
    - name: Use Production Environment Secrets
      run: |
        echo "Using production-specific secrets..."
        if [ -n "$PROD_API_KEY" ]; then
          echo "✓ Production API Key is configured"
        fi
        if [ -n "$PROD_SERVER" ]; then
          echo "✓ Production Server: $PROD_SERVER"
        fi
      env:
        PROD_API_KEY: ${{ secrets.PROD_API_KEY }}
        PROD_SERVER: ${{ vars.PROD_SERVER }}
        
    - name: Deploy to production
      run: |
        echo "Deploying to production..."
        echo "Using secure credentials from secrets"
        echo "✓ Production deployment successful!"
        
    - name: Notify deployment
      run: |
        echo "Sending notification..."
        # Here you could use SLACK_WEBHOOK or EMAIL secrets
        echo "Notification sent!"
